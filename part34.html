<!DOCTYPE HTML>
<html lang="en" class="ayu" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Sections 680–698 - TeX in C</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body class="sidebar-visible no-js">
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "ayu" : "ayu";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('ayu')
            html.classList.add(theme);
            var body = document.querySelector('body');
            body.classList.remove('no-js')
            body.classList.add('js');
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var body = document.querySelector('body');
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            body.classList.remove('sidebar-visible');
            body.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><li class="part-title">Part 1: Introduction</li><li class="chapter-item expanded "><a href="part01.html">Sections 1–16</a></li><li class="chapter-item expanded affix "><li class="part-title">Part 2: The character set</li><li class="chapter-item expanded "><a href="part02.html">Sections 17–24</a></li><li class="chapter-item expanded affix "><li class="part-title">Part 3: Input and output</li><li class="chapter-item expanded "><a href="part03.html">Sections 25–37</a></li><li class="chapter-item expanded affix "><li class="part-title">Part 4: String handling</li><li class="chapter-item expanded "><a href="part04.html">Sections 38–53</a></li><li class="chapter-item expanded affix "><li class="part-title">Part 5: On-line and off-line printing</li><li class="chapter-item expanded "><a href="part05.html">Sections 54–71</a></li><li class="chapter-item expanded affix "><li class="part-title">Part 6: Reporting errors</li><li class="chapter-item expanded "><a href="part06.html">Sections 72–98</a></li><li class="chapter-item expanded affix "><li class="part-title">Part 7: Arithmetic</li><li class="chapter-item expanded "><a href="part07.html">Sections 99–109</a></li><li class="chapter-item expanded affix "><li class="part-title">Part 8: Packed data</li><li class="chapter-item expanded "><a href="part08.html">Sections 110–114</a></li><li class="chapter-item expanded affix "><li class="part-title">Part 9: Dynamic memory allocation</li><li class="chapter-item expanded "><a href="part09.html">Sections 115–132</a></li><li class="chapter-item expanded affix "><li class="part-title">Part 10: Data structures for boxes and their friends</li><li class="chapter-item expanded "><a href="part10.html">Sections 133–161</a></li><li class="chapter-item expanded affix "><li class="part-title">Part 11: Memory layout</li><li class="chapter-item expanded "><a href="part11.html">Sections 162–172</a></li><li class="chapter-item expanded affix "><li class="part-title">Part 12: Displaying boxes</li><li class="chapter-item expanded "><a href="part12.html">Sections 173–198</a></li><li class="chapter-item expanded affix "><li class="part-title">Part 13: Destroying boxes</li><li class="chapter-item expanded "><a href="part13.html">Sections 199–202</a></li><li class="chapter-item expanded affix "><li class="part-title">Part 14: Copying boxes</li><li class="chapter-item expanded "><a href="part14.html">Sections 203–206</a></li><li class="chapter-item expanded affix "><li class="part-title">Part 15: The command codes</li><li class="chapter-item expanded "><a href="part15.html">Sections 207–210</a></li><li class="chapter-item expanded affix "><li class="part-title">Part 16: The semantic nest</li><li class="chapter-item expanded "><a href="part16.html">Sections 211–219</a></li><li class="chapter-item expanded affix "><li class="part-title">Part 17: The table of equivalents</li><li class="chapter-item expanded "><a href="part17.html">Sections 220–255</a></li><li class="chapter-item expanded affix "><li class="part-title">Part 18: The hash table</li><li class="chapter-item expanded "><a href="part18.html">Sections 256–267</a></li><li class="chapter-item expanded affix "><li class="part-title">Part 19: Saving and restoring equivalents</li><li class="chapter-item expanded "><a href="part19.html">Sections 268–288</a></li><li class="chapter-item expanded affix "><li class="part-title">Part 20: Token lists</li><li class="chapter-item expanded "><a href="part20.html">Sections 289–296</a></li><li class="chapter-item expanded affix "><li class="part-title">Part 21: Introduction to the syntactic routines</li><li class="chapter-item expanded "><a href="part21.html">Sections 297–299</a></li><li class="chapter-item expanded affix "><li class="part-title">Part 22: Input stacks and states</li><li class="chapter-item expanded "><a href="part22.html">Sections 300–320</a></li><li class="chapter-item expanded affix "><li class="part-title">Part 23: Maintaining the input stacks</li><li class="chapter-item expanded "><a href="part23.html">Sections 321–331</a></li><li class="chapter-item expanded affix "><li class="part-title">Part 24: Getting the next token</li><li class="chapter-item expanded "><a href="part24.html">Sections 332–365</a></li><li class="chapter-item expanded affix "><li class="part-title">Part 25: Expanding the next token</li><li class="chapter-item expanded "><a href="part25.html">Sections 336–401</a></li><li class="chapter-item expanded affix "><li class="part-title">Part 26: Basic scanning subroutines</li><li class="chapter-item expanded "><a href="part26.html">Sections 402–463</a></li><li class="chapter-item expanded affix "><li class="part-title">Part 27: Building token lists</li><li class="chapter-item expanded "><a href="part27.html">Sections 464–486</a></li><li class="chapter-item expanded affix "><li class="part-title">Part 28: Conditional processing</li><li class="chapter-item expanded "><a href="part28.html">Sections 487–510</a></li><li class="chapter-item expanded affix "><li class="part-title">Part 29: File names</li><li class="chapter-item expanded "><a href="part29.html">Sections 511–538</a></li><li class="chapter-item expanded affix "><li class="part-title">Part 30: Font metric data</li><li class="chapter-item expanded "><a href="part30.html">Sections 539–582</a></li><li class="chapter-item expanded affix "><li class="part-title">Part 31: Device-independent file format</li><li class="chapter-item expanded "><a href="part31.html">Sections 583–591</a></li><li class="chapter-item expanded affix "><li class="part-title">Part 32: Shipping pages out</li><li class="chapter-item expanded "><a href="part32.html">Sections 592–643</a></li><li class="chapter-item expanded affix "><li class="part-title">Part 33: Packaging</li><li class="chapter-item expanded "><a href="part33.html">Sections 644–679</a></li><li class="chapter-item expanded affix "><li class="part-title">Part 34: Data structures for math mode</li><li class="chapter-item expanded "><a href="part34.html" class="active">Sections 680–698</a></li><li class="chapter-item expanded affix "><li class="part-title">Part 35: Subroutines for math mode</li><li class="chapter-item expanded "><a href="part35.html">Sections 699–718</a></li><li class="chapter-item expanded affix "><li class="part-title">Part 36: Typesetting math formulas</li><li class="chapter-item expanded "><a href="part36.html">Sections 719–767</a></li><li class="chapter-item expanded affix "><li class="part-title">Part 37: Alignment</li><li class="chapter-item expanded "><a href="part37.html">Sections 768–812</a></li><li class="chapter-item expanded affix "><li class="part-title">Part 38: Breaking paragraphs into lines</li><li class="chapter-item expanded "><a href="part38.html">Sections 813–861</a></li><li class="chapter-item expanded affix "><li class="part-title">Part 39: Breaking paragraphs into lines, continued</li><li class="chapter-item expanded "><a href="part39.html">Sections 862–890</a></li><li class="chapter-item expanded affix "><li class="part-title">Part 40: Pre-hyphenation</li><li class="chapter-item expanded "><a href="part40.html">Sections 891–899</a></li><li class="chapter-item expanded affix "><li class="part-title">Part 41: Post-hyphenation</li><li class="chapter-item expanded "><a href="part41.html">Sections 900–918</a></li><li class="chapter-item expanded affix "><li class="part-title">Part 42: Hyphenation</li><li class="chapter-item expanded "><a href="part42.html">Sections 919–941</a></li><li class="chapter-item expanded affix "><li class="part-title">Part 43: Initializing the hyphenation tables</li><li class="chapter-item expanded "><a href="part43.html">Sections 942–966</a></li><li class="chapter-item expanded affix "><li class="part-title">Part 44: Breaking vertical lists into pages</li><li class="chapter-item expanded "><a href="part44.html">Sections 967–979</a></li><li class="chapter-item expanded affix "><li class="part-title">Part 45: The page builder</li><li class="chapter-item expanded "><a href="part45.html">Sections 980–1028</a></li><li class="chapter-item expanded affix "><li class="part-title">Part 46: The chief executive</li><li class="chapter-item expanded "><a href="part46.html">Sections 1029–1054</a></li><li class="chapter-item expanded affix "><li class="part-title">Part 47: Building boxes and lists</li><li class="chapter-item expanded "><a href="part47.html">Sections 1055–1135</a></li><li class="chapter-item expanded affix "><li class="part-title">Part 48: Building math lists</li><li class="chapter-item expanded "><a href="part48.html">Sections 1136–1207</a></li><li class="chapter-item expanded affix "><li class="part-title">Part 49: Mode-independent processing</li><li class="chapter-item expanded "><a href="part49.html">Sections 1208–1298</a></li><li class="chapter-item expanded affix "><li class="part-title">Part 50: Dumping and undumping the tables</li><li class="chapter-item expanded "><a href="part50.html">Sections 1299–1329</a></li><li class="chapter-item expanded affix "><li class="part-title">Part 51: The main program</li><li class="chapter-item expanded "><a href="part51.html">Sections 1330–1337</a></li><li class="chapter-item expanded affix "><li class="part-title">Part 52: Debugging</li><li class="chapter-item expanded "><a href="part52.html">Sections 1338–1339</a></li><li class="chapter-item expanded affix "><li class="part-title">Part 53: Extensions</li><li class="chapter-item expanded "><a href="part53.html">Sections 1340–1378</a></li><li class="chapter-item expanded affix "><li class="part-title">Part 54: System-dependent changes</li><li class="chapter-item expanded "><a href="part54.html">Sections 1379–1383</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">TeX in C</h1>

                    <div class="right-buttons">

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="section-680-data-structures-for-math-mode"><a class="header" href="#section-680-data-structures-for-math-mode">Section 680: Data structures for math mode</a></h1>
<p>When <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8988em;vertical-align:-0.2155em;"></span><span class="mord text"><span class="mord textrm">T</span><span class="mspace" style="margin-right:-0.1667em;"></span><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.4678em;"><span style="top:-2.7845em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord textrm">E</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2155em;"><span></span></span></span></span><span class="mspace" style="margin-right:-0.125em;"></span><span class="mord textrm">X</span></span></span></span></span> reads a formula that is enclosed between <code>$</code>’s, it constructs an <em>mlist</em>, which is essentially a tree structure representing that formula.
An mlist is a linear sequence of items, but we can regard it as a tree structure because mlists can appear within mlists.
For example, many of the entries can be subscripted or superscripted, and such “scripts” are mlists in their own right.</p>
<p>An entire formula is parsed into such a tree before any of the actual typesetting is done, because the current style of type is usually not known until the formula has been fully scanned.
For example, when the formula ‘<code>$a + b \over c + d$</code>’ is being read, there is no way to tell that ‘<code>a + b</code>’ will be in script size until ‘<code>\over</code>’ has appeared.</p>
<p>During the scanning process, each element of the mlist being built is classified as a relation, a binary operator, an open parenthesis, etc., or as a construct like ‘<code>\sqrt</code>’ that must be built up.
This classification appears in the mlist data structure.</p>
<p>After a formula has been fully scanned, the mlist is converted to an hlist so that it can be incorporated into the surrounding text.
This conversion is controlled by a recursive procedure that decides all of the appropriate styles by a “top-down” process starting at the outermost level and working in towards the subformulas.
The formula is ultimately pasted together using combinations of horizontal and vertical boxes, with glue and penalty nodes inserted as necessary.</p>
<p>An mlist is represented internally as a linked list consisting chiefly of “noads” (pronounced “no-adds”), to distinguish them from the somewhat similar “nodes” in hlists and vlists.
Certain kinds of ordinary nodes are allowed to appear in mlists together with the noads; <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8988em;vertical-align:-0.2155em;"></span><span class="mord text"><span class="mord textrm">T</span><span class="mspace" style="margin-right:-0.1667em;"></span><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.4678em;"><span style="top:-2.7845em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord textrm">E</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2155em;"><span></span></span></span></span><span class="mspace" style="margin-right:-0.125em;"></span><span class="mord textrm">X</span></span></span></span></span> tells the difference by means of the <em>type</em> field, since a noad’s <em>type</em> is always greater than that of a node.
An mlist does not contain character nodes, hlist nodes, vlist nodes, math nodes, ligature nodes, or unset nodes; in particular, each mlist item appears in the variable-size part of <em>mem</em>, so the <em>type</em> field is always present.</p>
<h1 id="section-681"><a class="header" href="#section-681">Section 681</a></h1>
<p>Each noad is four or more words long.
The first word contains the <em>type</em> and <em>subtype</em> and <em>link</em> fields that are already so familiar to us;
the second, third, and fourth words are called the noad’s <em>nucleus</em>, <em>subscr</em>, and <em>supscr</em> fields.</p>
<p>Consider, for example, the simple formula ‘<code>$x^2$</code>’, which would be parsed into an mlist containing a single element called an <em>ORD_NOAD</em>.
The <em>nucleus</em> of this noad is a representation of ‘<code>x</code>’, the <em>subscr</em> is empty, and the <em>supscr</em> is a representation of ‘<code>2</code>’.</p>
<p>The <em>nucleus</em>, <em>subscr</em>, and <em>supscr</em> fields are further broken into subfields.
If <em>p</em> points to a noad, and if <em>q</em> is one of its principal fields (e.g., <em>q = subscr(p)</em>), there are several possibilities for the subfields, depending on the <em>math_type</em> of <em>q</em>.</p>
<ul>
<li>
<p><em>math_type(q) = MATH_CHAR</em> means that <em>fam(q)</em> refers to one of
the sixteen font families, and <em>character(q)</em> is the number of a character
within a font of that family, as in a character node.</p>
</li>
<li>
<p><em>math_type(q) = MATH_TEXT_CHAR</em> is similar, but the character is
unsubscripted and unsuperscripted and it is followed immediately by another
character from the same font. (This <em>math_type</em> setting appears only
briefly during the processing; it is used to suppress unwanted italic
corrections.)</p>
</li>
<li>
<p><em>math_type(q) = EMPTY</em> indicates a field with no value (the
corresponding attribute of noad <em>p</em> is not present).</p>
</li>
<li>
<p><em>math_type(q) = SUB_BOX</em> means that <em>info(q)</em> points to a box
node (either an <em>HLIST_NODE</em> or a <em>VLIST_NODE</em>) that should be used as the
value of the field. The <em>shift_amount</em> in the subsidiary box node is the
amount by which that box will be shifted downward.</p>
</li>
<li>
<p><em>math_type(q) = SUB_MLIST</em> means that <em>info(q)</em> points to
an mlist; the mlist must be converted to an hlist in order to obtain
the value of this field.</p>
</li>
</ul>
<p>In the latter case, we might have <em>info(q) = null</em>.
This is not the same as <em>math_type(q) = EMPTY</em>; for example, ‘<code>$P_{}$</code>’ and ‘<code>$P$</code>’ produce different results (the former will not have the “italic correction” added to the width of <em>P</em>, but the “script skip” will be added).</p>
<p>The definitions of subfields given here are evidently wasteful of space, since a halfword is being used for the <em>math_type</em> although only three bits would be needed.
However, there are hardly ever many noads present at once, since they are soon converted to nodes that take up even more space, so we can afford to represent them in whatever way simplifies the programming.</p>
<div class="blockcode">
<div class="blockcode-header-fname">constants.h</div>
<pre><code class="language-c">#define NOAD_SIZE      4 // number of words in a normal noad
#define MATH_CHAR      1 // |math_type| when the attribute is simple
#define SUB_BOX        2 // |math_type| when the attribute is a box
#define SUB_MLIST      3 // |math_type| when the attribute is a formula
#define MATH_TEXT_CHAR 4 // |math_type| when italic correction is dubious
</code></pre>
</div>
<div class="blockcode">
<div class="blockcode-header-fname">texmath.h</div>
<pre><code class="language-c">// &lt;&lt; Start file |texmath.h|, 1381 &gt;&gt;

#define nucleus(X) ((X) + 1) // the |nucleus| field of a noad
#define supscr(X)  ((X) + 2) // the |supscr| field of a noad
#define subscr(X)  ((X) + 3) // the |subscr| field of a noad
#define math_type  link      // a |halfword| in |mem|
#define fam        font      // a |quarterword| in |mem|
</code></pre>
</div>
<h1 id="section-682"><a class="header" href="#section-682">Section 682</a></h1>
<p>Each portion of a formula is classified as Ord, Op, Bin, Rel, Open, Close, Punct, or Inner, for purposes of spacing and line breaking.
An <em>ORD_NOAD</em>, <em>OP_NOAD</em>, <em>BIN_NOAD</em>, <em>REL_NOAD</em>, <em>OPEN_NOAD</em>, <em>CLOSE_NOAD</em>, <em>PUNCT_NOAD</em>, or <em>INNER_NOAD</em> is used to represent portions of the various types.
For example, an ‘<code>=</code>’ sign in a formula leads to the creation of a <em>REL_NOAD</em> whose <em>nucleus</em> field is a representation of an equals sign (usually <em>fam = 0</em>, <em>character = 61</em>).
A formula preceded by <code>\mathrel</code> also results in a <em>REL_NOAD</em>.
When a <em>REL_NOAD</em> is followed by an <em>OP_NOAD</em>, say, and possibly separated by one or more ordinary nodes (not noads), <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8988em;vertical-align:-0.2155em;"></span><span class="mord text"><span class="mord textrm">T</span><span class="mspace" style="margin-right:-0.1667em;"></span><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.4678em;"><span style="top:-2.7845em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord textrm">E</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2155em;"><span></span></span></span></span><span class="mspace" style="margin-right:-0.125em;"></span><span class="mord textrm">X</span></span></span></span></span> will insert a penalty node (with the current <em>rel_penalty</em>) just after the formula that corresponds to the <em>REL_NOAD</em>, unless there already was a penalty immediately following; and a “thick space” will be inserted just before the formula that corresponds to the <em>OP_NOAD</em>.</p>
<p>A noad of type <em>ORD_NOAD</em>, <em>OP_NOAD</em>, <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.123em;"></span><span class="minner">…</span></span></span></span>, <em>INNER_NOAD</em> usually has a <em>subtype = NORMAL</em>.
The only exception is that an <em>OP_NOAD</em> might have <em>subtype = LIMITS</em> or <em>NO_LIMITS</em>, if the normal positioning of limits has been overridden for this operator.</p>
<div class="blockcode">
<div class="blockcode-header-fname">constants.h</div>
<pre><code class="language-c">#define ORD_NOAD   (UNSET_NODE + 3) // |type| of a noad classified Ord
#define OP_NOAD    (ORD_NOAD + 1)   // |type| of a noad classified Op
#define BIN_NOAD   (ORD_NOAD + 2)   // |type| of a noad classified Bin
#define REL_NOAD   (ORD_NOAD + 3)   // |type| of a noad classified Rel
#define OPEN_NOAD  (ORD_NOAD + 4)   // |type| of a noad classified Open
#define CLOSE_NOAD (ORD_NOAD + 5)   // |type| of a noad classified Close
#define PUNCT_NOAD (ORD_NOAD + 6)   // |type| of a noad classified Punct
#define INNER_NOAD (ORD_NOAD + 7)   // |type| of a noad classified Inner
#define LIMITS     1                // |subtype| of |OP_NOAD| whose scripts are to be above, below
#define NO_LIMITS  2                // |subtype| of |OP_NOAD| whose scripts are to be normal
</code></pre>
</div>
<h1 id="section-683"><a class="header" href="#section-683">Section 683</a></h1>
<p>A <em>RADICAL_NOAD</em> is five words long; the fifth word is the <em>left_delimiter</em> field, which usually represents a square root sign.</p>
<p>A <em>FRACTION_NOAD</em> is six words long; it has a <em>right_delimiter</em> field as well as a <em>left_delimiter</em>.</p>
<p>Delimiter fields are of type <em>four_quarters</em>, and they have four subfields called <em>small_fam</em>, <em>small_char</em>, <em>large_fam</em>, <em>large_char</em>.
These subfields represent variable-size delimiters by giving the “small” and “large” starting characters, as explained in Chapter 17 of <em>The TeXbook</em>.</p>
<p>A <em>FRACTION_NOAD</em> is actually quite different from all other noads.
Not only does it have six words, it has <em>thickness</em>, <em>denominator</em>, and <em>numerator</em> fields instead of <em>nucleus</em>, <em>subscr</em>, and <em>supscr</em>.
The <em>thickness</em> is a scaled value that tells how thick to make a fraction rule; however, the special value <em>DEFAULT_CODE</em> is used to stand for the <em>default_rule_thickness</em> of the current size.
The <em>numerator</em> and <em>denominator</em> point to mlists that define a fraction; we always have</p>
<div align="center">
<p><em>math_type(numerator) = math_type(denominator) = SUB_MLIST</em>.</p>
</div>
<p>The <em>left_delimiter</em> and <em>right_delimiter</em> fields specify delimiters that will be placed at the left and right of the fraction.
In this way, a <em>FRACTION_NOAD</em> is able to represent all of <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8988em;vertical-align:-0.2155em;"></span><span class="mord text"><span class="mord textrm">T</span><span class="mspace" style="margin-right:-0.1667em;"></span><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.4678em;"><span style="top:-2.7845em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord textrm">E</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2155em;"><span></span></span></span></span><span class="mspace" style="margin-right:-0.125em;"></span><span class="mord textrm">X</span></span></span></span></span>’s operators <code>\over</code>, <code>\atop</code>, <code>\above</code>, <code>\overwithdelims</code>, <code>\atopwithdelims</code>, and <code>\abovewithdelims</code>.</p>
<div class="blockcode">
<div class="blockcode-header-fname">constants.h</div>
<pre><code class="language-c">#define RADICAL_NOAD       (INNER_NOAD + 1)   // |type| of a noad for square roots
#define RADICAL_NOAD_SIZE  5                  // number of |mem| words in a radical noad
#define FRACTION_NOAD      (RADICAL_NOAD + 1) // |type| of a noad for generalized fractions
#define FRACTION_NOAD_SIZE 6                  // number of |mem| words in a fraction noad
#define DEFAULT_CODE       0x40000000         // denotes |default_rule_thickness|
</code></pre>
</div>
<div class="blockcode">
<div class="blockcode-header-fname">texmath.h</div>
<pre><code class="language-c">#define left_delimiter(X)  ((X) + 4)         // first delimiter field of a noad
#define right_delimiter(X) ((X) + 5)         // second delimiter field of a fraction noad
#define small_fam(X)       qqqq_b0(mem[(X)]) // |fam| for "small" delimiter
#define small_char(X)      qqqq_b1(mem[(X)]) // |character| for "small" delimiter
#define large_fam(X)       qqqq_b2(mem[(X)]) // |fam| for "large" delimiter
#define large_char(X)      qqqq_b3(mem[(X)]) // |character| for "large" delimiter
#define thickness          width             // |thickness| field in a fraction noad
#define numerator          supscr            // |numerator| field in a fraction noad
#define denominator        subscr            // |denominator| field in a fraction noad
</code></pre>
</div>
<h1 id="section-684"><a class="header" href="#section-684">Section 684</a></h1>
<p>The global variable <em>empty_field</em> is set up for initialization of empty fields in new noads.
Similarly, <em>null_delimiter</em> is for the initialization of delimiter fields.</p>
<div class="blockcode">
<div class="blockcode-header-bname">
<p>⟨ Global variables <a href="./part01.html#section-13">13</a> ⟩+≡</p>
</div>
<pre><code class="language-c">memory_word empty_field;
memory_word null_delimiter;
</code></pre>
</div>
<h1 id="section-685"><a class="header" href="#section-685">Section 685</a></h1>
<div class="blockcode">
<div class="blockcode-header-bname">
<p>⟨ Set initial values of key variables <a href="./part02.html#section-21">21</a> ⟩+≡</p>
</div>
<pre><code class="language-c">hh_rh(empty_field) = EMPTY;
hh_lh(empty_field) = null;
qqqq_b0(null_delimiter) = 0;
qqqq_b1(null_delimiter) = MIN_QUARTERWORD;
qqqq_b2(null_delimiter) = 0;
qqqq_b3(null_delimiter) = MIN_QUARTERWORD;
</code></pre>
</div>
<h1 id="section-686"><a class="header" href="#section-686">Section 686</a></h1>
<p>The <em>new_noad</em> function creates an <em>ORD_NOAD</em> that is completely null.</p>
<div class="blockcode">
<div class="blockcode-header-fname">math_structures.c</div>
<pre><code class="language-c">// &lt;&lt; Start file |math_structures.c|, 1382 &gt;&gt;

pointer new_noad() {
    pointer p;
    p = get_node(NOAD_SIZE);
    type(p) = ORD_NOAD;
    subtype(p) = NORMAL;
    mem[nucleus(p)] = empty_field;
    mem[subscr(p)] = empty_field;
    mem[supscr(p)] = empty_field;
    return p;
}
</code></pre>
</div>
<h1 id="section-687"><a class="header" href="#section-687">Section 687</a></h1>
<p>A few more kinds of noads will complete the set: An <em>UNDER_NOAD</em> has its nucleus underlined; an <em>OVER_NOAD</em> has it overlined.
An <em>ACCENT_NOAD</em> places an accent over its nucleus; the accent character appears as <em>fam(accent_chr(p))</em> and <em>character(accent_chr(p))</em>.
A <em>VCENTER_NOAD</em> centers its nucleus vertically with respect to the axis of the formula;
in such noads we always have <em>math_type(nucleus(p)) = sub_box</em>.</p>
<p>And finally, we have <em>LEFT_NOAD</em> and <em>RIGHT_NOAD</em> types, to implement <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8988em;vertical-align:-0.2155em;"></span><span class="mord text"><span class="mord textrm">T</span><span class="mspace" style="margin-right:-0.1667em;"></span><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.4678em;"><span style="top:-2.7845em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord textrm">E</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2155em;"><span></span></span></span></span><span class="mspace" style="margin-right:-0.125em;"></span><span class="mord textrm">X</span></span></span></span></span>’s <code>\left</code> and <code>\right</code>.
The <em>nucleus</em> of such noads is replaced by a <em>delimiter</em> field; thus, for example, ‘<code>\left(</code>’ produces a <em>LEFT_NOAD</em> such that <em>delimiter(p)</em> holds the family and character codes for all left parentheses.
A <em>LEFT_NOAD</em> never appears in an mlist except as the first element, and a <em>RIGHT_NOAD</em> never appears in an mlist except as the last element;
furthermore, we either have both a <em>LEFT_NOAD</em> and a <em>RIGHT_NOAD</em>, or neither one is present.
The <em>subscr</em> and <em>supscr</em> fields are always <em>empty</em> in a <em>LEFT_NOAD</em> and a <em>RIGHT_NOAD</em>.</p>
<div class="blockcode">
<div class="blockcode-header-fname">constants.h</div>
<pre><code class="language-c">#define UNDER_NOAD       (FRACTION_NOAD + 1) // |type| of a noad for underlining
#define OVER_NOAD        (UNDER_NOAD + 1)    // |type| of a noad for overlining
#define ACCENT_NOAD      (OVER_NOAD + 1)     // |type| of a noad for accented subformulas
#define ACCENT_NOAD_SIZE 5                   // number of |mem| words in an accent noad
#define VCENTER_NOAD     (ACCENT_NOAD + 1)   // |type| of a noad for \vcenter
#define LEFT_NOAD        (VCENTER_NOAD + 1)  // |type| of a noad for \left
#define RIGHT_NOAD       (LEFT_NOAD + 1)     // |type| of a noad for \right
</code></pre>
</div>
<div class="blockcode">
<div class="blockcode-header-fname">texmath.h</div>
<pre><code class="language-c">#define accent_chr(X)      ((X) + 4) // the |accent_chr| field of an accent noad
#define delimiter          nucleus   // |delimiter| field in left and right noads
#define scripts_allowed(X) (type((X)) &gt;= ORD_NOAD &amp;&amp; type((X)) &lt; LEFT_NOAD)
</code></pre>
</div>
<h1 id="section-688"><a class="header" href="#section-688">Section 688</a></h1>
<p>Math formulas can also contain instructions like <code>\textstyle</code> that override <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8988em;vertical-align:-0.2155em;"></span><span class="mord text"><span class="mord textrm">T</span><span class="mspace" style="margin-right:-0.1667em;"></span><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.4678em;"><span style="top:-2.7845em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord textrm">E</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2155em;"><span></span></span></span></span><span class="mspace" style="margin-right:-0.125em;"></span><span class="mord textrm">X</span></span></span></span></span>’s normal style rules.
A <em>STYLE_NODE</em> is inserted into the data structure to record such instructions;
it is three words long, so it is considered a node instead of a noad.
The <em>subtype</em> is either <em>DISPLAY_STYLE</em> or <em>TEXT_STYLE</em> or <em>SCRIPT_STYLE</em> or <em>SCRIPT_SCRIPT_STYLE</em>.
The second and third words of a <em>STYLE_NODE</em> are not used, but they are present because a <em>CHOICE_NODE</em> is converted to a <em>STYLE_NODE</em>.</p>
<p><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8988em;vertical-align:-0.2155em;"></span><span class="mord text"><span class="mord textrm">T</span><span class="mspace" style="margin-right:-0.1667em;"></span><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.4678em;"><span style="top:-2.7845em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord textrm">E</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2155em;"><span></span></span></span></span><span class="mspace" style="margin-right:-0.125em;"></span><span class="mord textrm">X</span></span></span></span></span> uses even numbers 0, 2, 4, 6 to encode the basic styles <em>DISPLAY_STYLE</em>, <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.123em;"></span><span class="minner">…</span></span></span></span>, <em>SCRIPT_SCRIPT_STYLE</em>, and adds 1 to get the “cramped” versions of these styles.
This gives a numerical order that is backwards from the convention of Appendix G in <em>The TeXbook</em>;
i.e., a smaller style has a larger numerical value.</p>
<div class="blockcode">
<div class="blockcode-header-fname">constants.h</div>
<pre><code class="language-c">#define STYLE_NODE          (UNSET_NODE + 1) // |type| of a style node
#define STYLE_NODE_SIZE     3                // number of words in a style node
#define DISPLAY_STYLE       0                // |subtype| for \displaystyle
#define TEXT_STYLE          2                // |subtype| for \textstyle
#define SCRIPT_STYLE        4                // |subtype| for \scriptstyle
#define SCRIPT_SCRIPT_STYLE 6                // |subtype| for \scriptscriptstyle
#define CRAMPED             1                // add this to an uncramped style if you want to cramp it
</code></pre>
</div>
<div class="blockcode">
<div class="blockcode-header-fname">math_structures.c</div>
<pre><code class="language-c">// create a style node
pointer new_style(small_number s) {
    pointer p; // the new node
    p = get_node(STYLE_NODE_SIZE);
    type(p) = STYLE_NODE;
    subtype(p) = s;
    width(p) = 0;
    depth(p) = 0; // the |width| and |depth| are not used
    return p;
}
</code></pre>
</div>
<h1 id="section-689"><a class="header" href="#section-689">Section 689</a></h1>
<p>Finally, the <code>\mathchoice</code> primitive creates a <em>CHOICE_NODE</em>, which has special subfields <em>display_mlist</em>, <em>text_mlist</em>, <em>script_mlist</em>, and <em>script_script_mlist</em> pointing to the mlists for each style.</p>
<div class="blockcode">
<div class="blockcode-header-fname">constants.h</div>
<pre><code class="language-c">#define CHOICE_NODE (UNSET_NODE + 2) // |type| of a choice node
</code></pre>
</div>
<div class="blockcode">
<div class="blockcode-header-fname">texmath.h</div>
<pre><code class="language-c">#define display_mlist(X)       info((X) + 1) // mlist to be used in display style
#define text_mlist(X)          link((X) + 1) // mlist to be used in text style
#define script_mlist(X)        info((X) + 2) // mlist to be used in script style
#define script_script_mlist(X) link((X) + 2) // mlist to be used in scriptscript style
</code></pre>
</div>
<div class="blockcode">
<div class="blockcode-header-fname">math_structures.c</div>
<pre><code class="language-c">// create a choice node
pointer new_choice() {
    pointer p; // the new node
    p = get_node(STYLE_NODE_SIZE);
    type(p) = CHOICE_NODE;
    subtype(p) = 0; // the |subtype| is not used
    display_mlist(p) = null;
    text_mlist(p) = null;
    script_mlist(p) = null;
    script_script_mlist(p) = null;
    return p;
}
</code></pre>
</div>
<h1 id="section-690"><a class="header" href="#section-690">Section 690</a></h1>
<p>Let’s consider now the previously unwritten part of <em>show_node_list</em> that displays the things that can only be present in mlists; this program illustrates how to access the data structures just defined.</p>
<p>In the context of the following program, <em>p</em> points to a node or noad that should be displayed, and the current string contains the “recursion history” that leads to this point.
The recursion history consists of a dot for each outer level in which <em>p</em> is subsidiary to some node, or in which <em>p</em> is subsidiary to the <em>nucleus</em> field of some noad; the dot is replaced by ‘<code>_</code>’ or ‘<code>^</code>’ or ‘<code>/</code>’ or ‘<code>\</code>’ if <em>p</em> is descended from the <em>subscr</em> or <em>supscr</em> or <em>denominator</em> or <em>numerator</em> fields of noads.
For example, the current string would be ‘<code>.^._/</code>’ if <em>p</em> points to the <em>ORD_NOAD</em> for <em>x</em> in the (ridiculous) formula ‘<code>$\sqrt{a^{\mathinner{b_{c\over x+y}}}}$</code>’.</p>
<div class="blockcode">
<div class="blockcode-header-bname">
<p>⟨ Cases of <em>show_node_list</em> that arise in mlists only <a href="./part34.html#section-690">690</a> ⟩≡</p>
</div>
<pre><code class="language-c">case STYLE_NODE:
    print_style(subtype(p));
    break;

case CHOICE_NODE:
    // &lt;&lt; Display choice node |p|, 695 &gt;&gt;
    break;

case ORD_NOAD:
case OP_NOAD:
case BIN_NOAD:
case REL_NOAD:
case OPEN_NOAD:
case CLOSE_NOAD:
case PUNCT_NOAD:
case INNER_NOAD:
case RADICAL_NOAD:
case OVER_NOAD:
case UNDER_NOAD:
case VCENTER_NOAD:
case ACCENT_NOAD:
case LEFT_NOAD:
case RIGHT_NOAD:
    // &lt;&lt; Display normal noad |p|, 696 &gt;&gt;
    break;

case FRACTION_NOAD:
    // &lt;&lt; Display fraction noad |p|, 697 &gt;&gt;
    break;
</code></pre>
<div class="blockcode-footer-usedin">
<p>This code is used in section <a href="./part12.html#section-183">183</a>.</p>
</div></div>
<h1 id="section-691"><a class="header" href="#section-691">Section 691</a></h1>
<p>Here are some simple routines used in the display of noads.</p>
<div class="blockcode">
<div class="blockcode-header-fname">display_math.c</div>
<pre><code class="language-c">// &lt;&lt; Start file |display_math.c|, 1382 &gt;&gt;

// prints family and character
void print_fam_and_char(pointer p) {
    print_esc("fam");
    print_int(fam(p));
    print_char(' ');
    print_strnumber(character(p));
}

// prints a delimiter as 24-bit hex value
void print_delimiter(pointer p) {
    int a; // accumulator
    a = small_fam(p)*256 + small_char(p);
    a = a*0x1000 + large_fam(p)*256 + large_char(p);
    if (a &lt; 0) {
        print_int(a); // this should never happen
    }
    else {
        print_hex(a);
    }
}
</code></pre>
</div>
<h1 id="section-692"><a class="header" href="#section-692">Section 692</a></h1>
<p>The next subroutine will descend to another level of recursion when a subsidiary mlist needs to be displayed.
The parameter <em>c</em> indicates what character is to become part of the recursion history.
An empty mlist is distinguished from a field with <em>math_type(p) = EMPTY</em>, because these are not equivalent (as explained above).</p>
<div class="blockcode">
<div class="blockcode-header-fname">display_math.c</div>
<pre><code class="language-c">// display a noad field
void print_subsidiary_data(pointer p, ASCII_code c) {
    if (cur_length &gt;= depth_threshold) {
        if (math_type(p) != EMPTY) {
            print(" []");
        }
    }
    else {
        append_char(c); // include |c| in the recursion history
        temp_ptr = p; // prepare for |show_info| if recursion is needed
        switch (math_type(p)) {
        case MATH_CHAR:
            print_ln();
            print_current_string();
            print_fam_and_char(p); 
            break;
        
        case SUB_BOX: show_info();
            break; // recursive call
        
        case SUB_MLIST:
            if (info(p) == null) {
                print_ln();
                print_current_string();
                print("{}");
            }
            else {
                show_info();
            }
            break; // recursive call
        
        default:
            do_nothing; //|EMPTY|
        }
        flush_char; // remove |c| from the recursion history
    }
}
</code></pre>
</div>
<h1 id="section-693"><a class="header" href="#section-693">Section 693</a></h1>
<p>The inelegant introduction of <em>show_info</em> in the code above seems better than the alternative of using Pascal’s strange <em>forward</em> declaration for a procedure with parameters.
The Pascal convention about dropping parameters from a post-<em>forward</em> procedure is, frankly, so intolerable to the author of <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8988em;vertical-align:-0.2155em;"></span><span class="mord text"><span class="mord textrm">T</span><span class="mspace" style="margin-right:-0.1667em;"></span><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.4678em;"><span style="top:-2.7845em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord textrm">E</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2155em;"><span></span></span></span></span><span class="mspace" style="margin-right:-0.125em;"></span><span class="mord textrm">X</span></span></span></span></span> that he would rather stoop to communication via a global temporary variable.
(A similar stoopidity occurred with respect to <em>hlist_out</em> and <em>vlist_out</em> above, and it will occur with respect to <em>mlist_to_hlist</em> below.)</p>
<div class="blockcode">
<div class="blockcode-header-fname">display_math.c</div>
<pre><code class="language-c">// the reader will kindly forgive this
void show_info() {
    show_node_list(info(temp_ptr));
}
</code></pre>
</div>
<h1 id="section-694"><a class="header" href="#section-694">Section 694</a></h1>
<div class="blockcode">
<div class="blockcode-header-fname">display_math.c</div>
<pre><code class="language-c">void print_style(int c) {
    switch (c / 2) {
    case 0:
        print_esc("displaystyle");
        break; // |DISPLAY_STYLE = 0|
    
    case 1:
        print_esc("textstyle");
        break; // |TEXT_STYLE = 2|
    
    case 2:
        print_esc("scriptstyle");
        break; // |SCRIPT_STYLE = 4|
    
    case 3:
        print_esc("scriptscriptstyle");
        break; // |SCRIPT_SCRIPT_STYLE = 6|
    
    default:
        print("Unknown style!");
    }
}
</code></pre>
</div>
<h1 id="section-695"><a class="header" href="#section-695">Section 695</a></h1>
<div class="blockcode">
<div class="blockcode-header-bname">
<p>⟨ Display choice node <em>p</em> <a href="./part34.html#section-695">695</a> ⟩≡</p>
</div>
<pre><code class="language-c">print_esc("mathchoice");
append_char('D');
show_node_list(display_mlist(p));
flush_char;
append_char('T');
show_node_list(text_mlist(p));
flush_char;
append_char('S');
show_node_list(script_mlist(p));
flush_char;
append_char('s');
show_node_list(script_script_mlist(p));
flush_char;
</code></pre>
<div class="blockcode-footer-usedin">
<p>This code is used in section <a href="./part34.html#section-690">690</a>.</p>
</div></div>
<h1 id="section-696"><a class="header" href="#section-696">Section 696</a></h1>
<div class="blockcode">
<div class="blockcode-header-bname">
<p>⟨ Display normal noad <em>p</em> <a href="./part34.html#section-696">696</a> ⟩≡</p>
</div>
<pre><code class="language-c">switch (type(p)) {
case ORD_NOAD:
    print_esc("mathord");
    break;

case OP_NOAD:
    print_esc("mathop");
    break;

case BIN_NOAD:
    print_esc("mathbin");
    break;

case REL_NOAD:
    print_esc("mathrel");
    break;

case OPEN_NOAD:
    print_esc("mathopen");
    break;

case CLOSE_NOAD:
    print_esc("mathclose");
    break;

case PUNCT_NOAD:
    print_esc("mathpunct");
    break;

case INNER_NOAD:
    print_esc("mathinner");
    break;

case OVER_NOAD:
    print_esc("overline");
    break;

case UNDER_NOAD:
    print_esc("underline");
    break;

case VCENTER_NOAD:
    print_esc("vcenter");
    break;

case RADICAL_NOAD:
    print_esc("radical");
    print_delimiter(left_delimiter(p));
    break;

case ACCENT_NOAD:
    print_esc("accent");
    print_fam_and_char(accent_chr(p));
    break;

case LEFT_NOAD:
    print_esc("left");
    print_delimiter(delimiter(p));
    break;

case RIGHT_NOAD:
    print_esc("right");
    print_delimiter(delimiter(p));
}
if (subtype(p) != NORMAL) {
    if (subtype(p) == LIMITS) {
        print_esc("limits");
    }
    else {
        print_esc("nolimits");
    }
}
if (type(p) &lt; LEFT_NOAD) {
    print_subsidiary_data(nucleus(p), '.');
}
print_subsidiary_data(supscr(p), '^');
print_subsidiary_data(subscr(p), '_');
</code></pre>
<div class="blockcode-footer-usedin">
<p>This code is used in section <a href="./part34.html#section-690">690</a>.</p>
</div></div>
<h1 id="section-697"><a class="header" href="#section-697">Section 697</a></h1>
<div class="blockcode">
<div class="blockcode-header-bname">
<p>⟨ Display fraction noad <em>p</em> <a href="./part34.html#section-697">697</a> ⟩≡</p>
</div>
<pre><code class="language-c">print_esc("fraction, thickness ");
if (thickness(p) == DEFAULT_CODE) {
    print("= default");
}
else {
    print_scaled(thickness(p));
}
if (small_fam(left_delimiter(p)) != 0
    || small_char(left_delimiter(p)) != MIN_QUARTERWORD
    || large_fam(left_delimiter(p)) != 0
    || large_char(left_delimiter(p)) != MIN_QUARTERWORD)
{
    print(", left-delimiter ");
    print_delimiter(left_delimiter(p));
}
if (small_fam(right_delimiter(p)) != 0
    || small_char(right_delimiter(p)) != MIN_QUARTERWORD
    || large_fam(right_delimiter(p)) != 0
    || large_char(right_delimiter(p)) != MIN_QUARTERWORD)
{
    print(", right-delimiter ");
    print_delimiter(right_delimiter(p));
}
print_subsidiary_data(numerator(p), '\\');
print_subsidiary_data(denominator(p), '/');
</code></pre>
<div class="blockcode-footer-usedin">
<p>This code is used in section <a href="./part34.html#section-690">690</a>.</p>
</div></div>
<h1 id="section-698"><a class="header" href="#section-698">Section 698</a></h1>
<p>That which can be displayed can also be destroyed.</p>
<div class="blockcode">
<div class="blockcode-header-bname">
<p>⟨ Cases of <em>flush_node_list</em> that arise in mlists only <a href="./part34.html#section-698">698</a> ⟩≡</p>
</div>
<pre><code class="language-c">case STYLE_NODE:
    free_node(p, STYLE_NODE_SIZE);
    goto done;

case CHOICE_NODE:
    flush_node_list(display_mlist(p));
    flush_node_list(text_mlist(p));
    flush_node_list(script_mlist(p));
    flush_node_list(script_script_mlist(p));
    free_node(p, STYLE_NODE_SIZE);
    goto done;

case ORD_NOAD:
case OP_NOAD:
case BIN_NOAD:
case REL_NOAD:
case OPEN_NOAD:
case CLOSE_NOAD:
case PUNCT_NOAD:
case INNER_NOAD:
case RADICAL_NOAD:
case OVER_NOAD:
case UNDER_NOAD:
case VCENTER_NOAD:
case ACCENT_NOAD:
    if (math_type(nucleus(p)) &gt;= SUB_BOX) {
        flush_node_list(info(nucleus(p)));
    }
    if (math_type(supscr(p)) &gt;= SUB_BOX) {
        flush_node_list(info(supscr(p)));
    }
    if (math_type(subscr(p)) &gt;= SUB_BOX) {
        flush_node_list(info(subscr(p)));
    }
    if (type(p) == RADICAL_NOAD) {
        free_node(p, RADICAL_NOAD_SIZE);
    }
    else if (type(p) == ACCENT_NOAD) {
        free_node(p, ACCENT_NOAD_SIZE);
    }
    else {
        free_node(p, NOAD_SIZE);
    }
    goto done;

case LEFT_NOAD:
case RIGHT_NOAD:
    free_node(p, NOAD_SIZE);
    goto done;

case FRACTION_NOAD:
    flush_node_list(info(numerator(p)));
    flush_node_list(info(denominator(p)));
    free_node(p, FRACTION_NOAD_SIZE);
    goto done;
</code></pre>
<div class="blockcode-footer-usedin">
<p>This code is used in section <a href="./part13.html#section-202">202</a>.</p>
</div></div>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="part33.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="part35.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="part33.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="part35.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
